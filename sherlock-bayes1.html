<html>
<head><title>Sherlock Bayes, logical detective. A murder mystery game</title></head>
<body>
<div id="sherlockBayes150129" style="height:640px; width:635px; font-family:'Times New Roman'; background-color:Olive; font-size:16px; line-height:17px">
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javaScript">
(function () {
/*
features to implement:
resources that limit stuff
different accuracy depending on category
categories:
alibi
motive
forensic
psychological evaluation
witnesses
random hot tips - cheap cost
great detective insight - higher accuracy
different starting priors
cheaper cost to fill out row/column
cheaper cost for random
difficulty levels
pictures,reactions, tutorial, ui, etc.
*/



var DIV_CONTAINER_ID = "sherlockBayes150129";
var postBody=document.getElementById(DIV_CONTAINER_ID);

var NUM_CATEGORIES=5
var P_FALSELY=1/3



function chooseRandom(pArray){ // chooses a random element given a probability distribution array
	var rand=Math.random()
	var sum=0
	var i=0
	while (rand>sum) {
		sum+=pArray[i]
		if (i===pArray.length-1){sum+=1}
		i++
	}
	return i-1
}

function makeEvidenceChart(priors,n){
	var evidenceChart=[]
	var culprit=chooseRandom(priors)
	for (var suspect=0;suspect<priors.length;suspect++) {
		var suspectArray=[]
		if (suspect===culprit) {
			for (var i=0;i<n;i++){
				suspectArray.push(true)
			}
		} else {
			var falseCount=0
			for (var i=0;i<n;i++){
				if (Math.random()<P_FALSELY){
					suspectArray.push(true)
				} else {
					suspectArray.push(false)
					falseCount++
				}
			}
			if (falseCount===0) {
				suspectArray[Math.floor(Math.random()*n)]=false
			}
		}
		evidenceChart.push(suspectArray)
	}
	evidenceChart.culprit=culprit
	evidenceChart.query=function(suspect,category,accuracy){
		var suspicion=evidenceChart[suspect][category]
		if (Math.random()<accuracy) {
			return suspicion
		} else {
			return !suspicion
		}
	}
	return evidenceChart
}

function generateDist(){
	var randArray=[]
	var sum=0
	for (var i=0;i<4;i++){
		var rand=Math.random()*0.8+0.2
		randArray.push(rand)
		sum+=rand
	}
	var partialSum=0
	for (var i=0;i<randArray.length-1;i++){
		randArray[i]/=sum
		partialSum+=randArray[i]
	}
	randArray[randArray.length-1]=1-partialSum
	return randArray
}
var pDist=generateDist()
var chart=makeEvidenceChart(pDist,NUM_CATEGORIES)
//console.log(chart)
//console.log("query test", chart.query(3,1,0.5))

function makeChartUI(chart,x,y){
	var chartUI=[]
	for (var i=0;i<chart.length;i++) {
		var column=[]
		for (var j=0;j<chart[0].length;j++) {
			var div=document.createElement("DIV")
			div.style.backgroundColor="rgb(250,250,100)"
			div.style.position="absolute"
			div.style.height=39
			div.style.width=94
			div.style.top=j*(parseInt(div.style.height)+1)+y
			div.style.left=i*(parseInt(div.style.width)+1)+x
			div.style.textAlign="center"
			//div.innerHTML=chart[i][j]
			div.prevQ=[] // new thing. keeps track of previous queries.
			div.suspect=i
			div.category=j
			div.onclick=function(){
				processClick(this.suspect,this.category,chart,chartUI,pDist)
			}
			postBody.appendChild(div)
			column.push(div)
		}
		chartUI.push(column)
	}
	return chartUI
}

var chartUI=makeChartUI(chart,235,250)

function processClick(suspect,category,chart,chartUI,pDist){
	//console.log("before",pDist)
	var cost=10
	var acccuracy
	//var accuracy=Math.random()*0.5+0.5 //maybe make accuracy based on category
	switch (category) {
		case 0:
			accuracy=0.85+0.15*2*(Math.random()-0.5)
			cost+=5
			//forensics: high accuracy, high cost
			break
		case 1:
			accuracy=0.75+0.15*2*(Math.random()-0.5)
			cost+=Math.round((Math.random()-0.5)*5)
			//motive: variable cost
			break
		case 2:
			accuracy=0.75+0.15*2*(Math.random()-0.5)
			cost+=0
			//alibi: standard cost and accuracy
			break
		case 3:
			accuracy=0.65+0.15*2*(Math.random()-0.5)
			cost-=5
			//character witnesses: low accuracy, low cost
			break
		case 4:
			accuracy=0.75+0.25*2*(Math.random()-0.5)
			cost+=0
			//eyewitnesses: highly variable accuracy
			break
	}
	//accuracy=1
	//console.log(cost)
	var result=chart.query(suspect,category,accuracy)
	var q={result:result, suspect:suspect, category:category, accuracy:accuracy}
	var post=bayesTheorem(q,pDist,chartUI)
	for (var i=0;i<post.length;i++){
		pDist[i]=post[i]
	}
	pBars.update(pDist)
	pDistReport.update(pDist)
	//var pTrue=accuracy
	//if (!result) {pTrue=1-pTrue}
	chartUI[suspect][category].innerHTML=result+"<br>"+Math.round(accuracy*100)+"%"
	//console.log("after",pDist)
}

var answersButton=document.createElement("BUTTON")
answersButton.style.position="absolute"
answersButton.style.top=300
answersButton.style.left=500
answersButton.innerHTML="show answers"
answersButton.onclick=function(){
	for (var i=0;i<chartUI.length;i++){
		for (var j=0;j<chartUI[0].length;j++){
			chartUI[i][j].innerHTML=chart[i][j]
		}

	}
}
//postBody.appendChild(answersButton)

/*/statistics testing
function getMax(array){
	var max=array[0]
	var maxI=0
	for (var i=0;i<array.length;i++){
		if (array[i]>max) {
			max=array[i]
			maxI=i
		}
	}
	return maxI
}
var total=10000
var right=0
var pSum=0
for (var i=0;i<total;i++){
	while (pDist[getMax(pDist)]<0.50) {
		var x=Math.floor(Math.random()*4)
		var y=Math.floor(Math.random()*5)
		processClick(x,y,chart,chartUI,pDist)
	}
	var accuse=getMax(pDist)
	var pVal=pDist[getMax(pDist)]
	if (accuse===chart.culprit){right++}
	pSum+=pVal
	pDist=generateDist()
	chart=makeEvidenceChart(pDist,NUM_CATEGORIES)
	chartUI=makeChartUI(chart)

}
console.log("theory:",pSum/total," experiment:",right/total)
//*/


function pFalseSuspicion(q,chartUI){ // the probability of having "true" even if innocent, takes previous q into account
	var prob=P_FALSELY-Math.pow(P_FALSELY,NUM_CATEGORIES)/NUM_CATEGORIES
	var qList=chartUI[q.suspect][q.category].prevQ
	for (var i=0;i<qList.length;i++){
		var likelihood=qList[i].accuracy
		if (!qList[i].result) {likelihood=1-likelihood}
		prob=prob*likelihood/(prob*likelihood+(1-prob)*(1-likelihood))
	}
	return prob
}
	
/*	
var falseSusp=0 //testing pFalseSuspicion(n,p)
for (var i=0;i<1000;i++){
	var testChart=makeEvidenceChart([1,0,0,0],5)
	if (testChart.query(3,0,1)){
		falseSusp++
		//console.log(testChart,falseSusp)
	}
}
console.log("exp:", falseSusp/1000, "theory: ",pFalseSuspicion({result:true,suspect:1,category:0,accuracy:1},chartUI))
*/

function likelihood(q,suspect,chartUI) { //P(qResult for qSuspect|suspect)
	if (suspect===q.suspect) {
		if (q.result){return q.accuracy}
		else {return 1-q.accuracy}
	} else {
		var pFalsely=pFalseSuspicion(q,chartUI)
		var pTrue=pFalsely*q.accuracy+(1-pFalsely)*(1-q.accuracy)
		if (q.result){return pTrue}
		else {return 1-pTrue}
	}
}

//console.log(likelihood(true,1,0.9,0))

function denominator(q,priors,chartUI){ //P(result)
	var prob=0
	for (var i=0;i<priors.length;i++){
		prob+=priors[i]*likelihood(q,i,chartUI)
	}
	return prob
}

function bayesTheorem(q,priors,chartUI){
	var posteriors=[]
	var denom=denominator(q,priors,chartUI)
	for (var i=0;i<priors.length;i++){
		var prob=priors[i]*likelihood(q,i,chartUI)/denom
		posteriors.push(prob)
	}
	chartUI[q.suspect][q.category].prevQ.push(q)
	return posteriors
}
//q={result:,suspect, category, accuracy}
//bayes theorem mechanics test
/*
var p1=bayesTheorem({result:true,suspect:1,category:1,accuracy:0.8},[0.25,0.25,0.25,0.25],chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:2,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:3,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:0,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:1,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:2,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:3,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:0,accuracy:0.8},p1,chartUI)
console.log(p1)
p1=bayesTheorem({result:true,suspect:1,category:1,accuracy:0.8},p1,chartUI)
console.log(p1)

console.log(chartUI)
*/


function makePBars(pDist,width,x,y){ //array of array of divs
	var pBars=[]
	pBars.spacing=width
	for (var i=0;i<pDist.length;i++){
		var div=document.createElement("DIV")
		div.style.backgroundColor="rgb(120,120,250)"
		div.style.position="absolute"
		div.style.height=Math.round(pDist[i]*100)
		div.style.width=10
		div.style.bottomCoord=y // new thing, indicates the bottom of the bar
		div.style.top=div.style.bottomCoord-parseInt(div.style.height)
		div.style.left=i*pBars.spacing+x
		div.style.borderStyle="solid"
		div.style.borderWidth="1px"
		postBody.appendChild(div)
		pBars.push([div])
	}
	pBars.update=function(newDist){
		for (var i=0;i<pBars.length;i++){
			var oldBar=$(pBars[i][0]).clone()[0]
			postBody.appendChild(oldBar)
			oldBar.style.backgroundColor="rgba(210,210,250,0.7)"
			pBars[i].splice(1,0,oldBar)
			if (pBars[i].length>10){
				var toDelete=pBars[i].pop()
				$(toDelete).remove()
			}
			for (var j=1;j<pBars[i].length;j++){
				var newBGColor="rgba(210,210,250,"+(0.8-j/10)+")"
				//console.log(newBGColor)
				$(pBars[i][j]).animate({
					left:"+="+(12-j),//i*pBars.spacing+20+j*11,
					opacity:"-=0.11",
					width:"-=1"
				})
			}
			//console.log(pBars[i])
			//oldBar.style.left=i*parseInt(oldBar.style.width)+40
			$(pBars[i][0]).animate({
				top:pBars[i][0].style.bottomCoord-Math.round(newDist[i]*100),
				height:Math.round(newDist[i]*100)
			},"slow")
		}
	}
	return pBars
}

var pBars=makePBars(pDist,parseInt(chartUI[0][0].style.width),258,140)

function reportPDist(pDist,width,x,y){
	pDistReport=[]
	for (var i=0;i<pDist.length;i++){
		var text=document.createElement("SPAN")
		text.innerHTML=Math.round(pDist[i]*100)+"%"
		text.style.position="absolute"
		text.style.width=width
		text.style.color="rgba(0,0,0,1)"
		text.style.left=width*i+x
		text.style.top=y
		postBody.appendChild(text)
		pDistReport.push([text])
	}
	pDistReport.update=function(pDist){
		for (var i=0;i<pDist.length;i++){
			if (pDistReport[i].length>=2){
				var toDelete=pDistReport[i].pop()
				$(toDelete).remove()
			}
			pDistReport[i].push($(pDistReport[i][0]).clone()[0])
			postBody.appendChild(pDistReport[i][1])
			//pDistReport[i][1].innerHTML="<="+pDistReport[i][1].innerHTML
			$(pDistReport[i][1]).animate({
				left:"+=40", 
				opacity:"-=0.3",
				fontSize:"-=4",
				top:"+=1"
			},"fast")//,function(){pDistReport[i][1].innerHTML="<-"+pDistReport[i][1].innerHTML})
			pDistReport[i][0].innerHTML=Math.round(pDist[i]*100)+"%"
			$(pDistReport[i][0]).animate({fontSize:"+=3"},"fast").animate({fontSize:"-=3"},"fast")
		}
	}
	return pDistReport
}

var pDistReport=reportPDist(pDist,parseInt(chartUI[0][0].style.width),255,145)


function makePortraits(n,width,x,y){
	var portraits=[]
	for (var i=0;i<n;i++){
		var face=document.createElement("IMG")
		face.src=i+".png"
		face.style.position="absolute"
		face.style.top=y
		face.style.left=(i*parseInt(width)+x)
		face.onclick=function(){accuse(this)}
		postBody.appendChild(face)
	}
	return portraits
}

function accuse(portrait){
	console.log(portrait.src)
	answersButton.onclick()
}

var portraits=makePortraits(4,chartUI[0][0].style.width,250,185)
var sherlockBayesPortrait=document.createElement("IMG")
sherlockBayesPortrait.src="sherlockBayes180.png"
sherlockBayesPortrait.style.position="absolute"
sherlockBayesPortrait.style.top=200
sherlockBayesPortrait.style.left=15
postBody.appendChild(sherlockBayesPortrait)




}());

</script>

</body>
</html>